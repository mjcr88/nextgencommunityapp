# Test Design: Story 1.2.5 - Admin Tenant & Lot Management

**Date:** October 14, 2025  
**Designer:** Quinn (Test Architect)  
**Story Status:** In Progress

---

## Test Strategy Overview

**Key Principles:**
1. **Pure Unit Tests First** - Test business logic without mocking Supabase
2. **Small, Focused Files** - One concern per file, < 100 lines
3. **Type Safety** - No type gymnastics, if types break the test is wrong
4. **Fast Execution** - Unit tests complete in < 5 seconds
5. **Standalone Integration** - Optional, manual RLS verification tests

**Total Test Scenarios:** 22
- **Pure Unit Tests:** 15 (66%)
- **Lightweight Integration:** 5 (23%)
- **Manual RLS Verification:** 2 (11%)

**Priority Distribution:**
- **P0 (Must Pass):** 12 tests
- **P1 (Should Pass):** 8 tests  
- **P2 (Nice to Have):** 2 tests

---

## File Structure

```
packages/
├── shared/
│   └── lib/
│       └── schemas/
│           └── __tests__/
│               ├── neighborhood.schema.test.ts      # 3 tests, ~50 lines
│               └── lot.schema.test.ts              # 4 tests, ~60 lines
│
└── database/
    └── src/
        └── lib/
            └── repositories/
                └── __tests__/
                    ├── neighborhood.validation.test.ts   # 3 tests, ~70 lines
                    ├── neighborhood.queries.test.ts      # 2 tests, ~80 lines
                    ├── lot.validation.test.ts            # 5 tests, ~90 lines
                    └── lot.queries.test.ts               # 2 tests, ~80 lines

apps/
└── web/
    └── app/
        └── actions/
            └── __tests__/
                ├── admin.validation.test.ts              # 3 tests, ~60 lines
                └── admin.integration.test.ts             # 5 tests, ~100 lines (optional)

# Manual verification (not automated)
scripts/
└── test-rls/
    ├── verify-neighborhood-isolation.sql             # Manual SQL queries
    └── verify-lot-isolation.sql                      # Manual SQL queries
```

---

## Test Scenarios by Acceptance Criteria

### AC1: Database Schema with RLS

**Coverage Strategy:** Manual verification + lightweight integration

#### 1.2.5-MANUAL-001: RLS Neighborhood Isolation (P0)

**Type:** Manual SQL Verification  
**Priority:** P0  
**File:** `scripts/test-rls/verify-neighborhood-isolation.sql`

**Purpose:** Verify cross-tenant isolation for neighborhoods table

**Test Steps:**
```sql
-- Setup: Create two tenants and neighborhoods
BEGIN;

INSERT INTO tenants (id, name, slug) VALUES 
  ('tenant-a-uuid', 'Tenant A', 'tenant-a'),
  ('tenant-b-uuid', 'Tenant B', 'tenant-b');

INSERT INTO neighborhoods (tenant_id, name) VALUES
  ('tenant-a-uuid', 'Neighborhood A1'),
  ('tenant-b-uuid', 'Neighborhood B1');

-- Test: Set session to Tenant A and try to access Tenant B data
SET LOCAL role TO authenticated;
SET LOCAL request.jwt.claims TO '{"tenant_id": "tenant-a-uuid", "role": "admin"}';

-- This MUST return only Tenant A neighborhoods
SELECT * FROM neighborhoods WHERE tenant_id = 'tenant-b-uuid';
-- Expected: Empty result set (0 rows)

-- Verify own tenant access works
SELECT * FROM neighborhoods WHERE tenant_id = 'tenant-a-uuid';
-- Expected: 1 row (Neighborhood A1)

ROLLBACK;
```

**Expected Outcomes:**
- ✅ Cross-tenant query returns 0 rows
- ✅ Own tenant query returns expected data
- ✅ No errors, no data leakage

**Justification:** Pure SQL verification avoids TypeScript/mock complexity while directly testing RLS policies

---

#### 1.2.5-MANUAL-002: RLS Lot Isolation via Neighborhood FK (P0)

**Type:** Manual SQL Verification  
**Priority:** P0  
**File:** `scripts/test-rls/verify-lot-isolation.sql`

**Purpose:** Verify lots are isolated by tenant through neighborhood FK

**Test Steps:**
```sql
BEGIN;

-- Setup from previous test plus lots
INSERT INTO lots (neighborhood_id, lot_number, status) VALUES
  ((SELECT id FROM neighborhoods WHERE name = 'Neighborhood A1'), '101', 'available'),
  ((SELECT id FROM neighborhoods WHERE name = 'Neighborhood B1'), '201', 'available');

-- Test: Tenant A session tries to access Tenant B lot
SET LOCAL role TO authenticated;
SET LOCAL request.jwt.claims TO '{"tenant_id": "tenant-a-uuid", "role": "admin"}';

-- Direct lot query with Tenant B neighborhood
SELECT * FROM lots 
WHERE neighborhood_id IN (
  SELECT id FROM neighborhoods WHERE tenant_id = 'tenant-b-uuid'
);
-- Expected: Empty result set

-- Verify own lots accessible
SELECT * FROM lots 
WHERE neighborhood_id IN (
  SELECT id FROM neighborhoods WHERE tenant_id = 'tenant-a-uuid'
);
-- Expected: 1 row (lot 101)

ROLLBACK;
```

---

### AC2: Zod Schemas

#### 1.2.5-UNIT-001: Neighborhood Schema Valid Input (P0)

**Type:** Unit  
**Priority:** P0  
**Level:** Unit  
**File:** `packages/shared/lib/schemas/__tests__/neighborhood.schema.test.ts`

**Test:**
```typescript
import { describe, test, expect } from 'vitest';
import { 
  NeighborhoodInsertSchema, 
  NeighborhoodUpdateSchema 
} from '../neighborhood';

describe('NeighborhoodInsertSchema', () => {
  test('validates complete neighborhood input', () => {
    const validInput = {
      tenant_id: '123e4567-e89b-12d3-a456-426614174000',
      name: 'Almendro',
      description: 'Primary residential area',
      settings: { color: '#green', active: true }
    };
    
    const result = NeighborhoodInsertSchema.safeParse(validInput);
    
    expect(result.success).toBe(true);
    if (result.success) {
      expect(result.data.name).toBe('Almendro');
      expect(result.data.settings).toEqual({ color: '#green', active: true });
    }
  });

  test('validates minimal required fields', () => {
    const minimalInput = {
      tenant_id: '123e4567-e89b-12d3-a456-426614174000',
      name: 'Bamboo'
    };
    
    const result = NeighborhoodInsertSchema.safeParse(minimalInput);
    
    expect(result.success).toBe(true);
    if (result.success) {
      expect(result.data.name).toBe('Bamboo');
      expect(result.data.description).toBeUndefined();
    }
  });
});
```

**Justification:** Pure validation logic, no database needed

---

#### 1.2.5-UNIT-002: Neighborhood Schema Invalid Tenant ID (P0)

**Type:** Unit  
**Priority:** P0  
**File:** `packages/shared/lib/schemas/__tests__/neighborhood.schema.test.ts`

**Test:**
```typescript
test('rejects invalid tenant_id format', () => {
  const invalidInput = {
    tenant_id: 'not-a-uuid',
    name: 'Test'
  };
  
  const result = NeighborhoodInsertSchema.safeParse(invalidInput);
  
  expect(result.success).toBe(false);
  if (!result.success) {
    expect(result.error.issues[0].path).toContain('tenant_id');
  }
});
```

---

#### 1.2.5-UNIT-003: Neighborhood Schema Settings JSONB (P1)

**Type:** Unit  
**Priority:** P1  
**File:** `packages/shared/lib/schemas/__tests__/neighborhood.schema.test.ts`

**Test:**
```typescript
test('validates complex nested settings JSONB', () => {
  const input = {
    tenant_id: '123e4567-e89b-12d3-a456-426614174000',
    name: 'Cedar',
    settings: {
      features: ['pool', 'gym'],
      metadata: {
        capacity: 100,
        status: 'active'
      }
    }
  };
  
  const result = NeighborhoodInsertSchema.safeParse(input);
  
  expect(result.success).toBe(true);
  if (result.success) {
    expect(result.data.settings?.features).toEqual(['pool', 'gym']);
    expect(result.data.settings?.metadata?.capacity).toBe(100);
  }
});
```

**Justification:** Validates JsonZod schema from Story 1.2 works for complex nested objects

---

#### 1.2.5-UNIT-004: Lot Schema Valid Input (P0)

**Type:** Unit  
**Priority:** P0  
**File:** `packages/shared/lib/schemas/__tests__/lot.schema.test.ts`

**Test:**
```typescript
import { describe, test, expect } from 'vitest';
import { LotInsertSchema, LotUpdateSchema } from '../lot';

describe('LotInsertSchema', () => {
  test('validates complete lot input', () => {
    const validInput = {
      neighborhood_id: '123e4567-e89b-12d3-a456-426614174000',
      lot_number: '101',
      status: 'available' as const,
      geo_bounds: {
        type: 'Polygon',
        coordinates: [[[0, 0], [1, 0], [1, 1], [0, 1], [0, 0]]]
      }
    };
    
    const result = LotInsertSchema.safeParse(validInput);
    
    expect(result.success).toBe(true);
    if (result.success) {
      expect(result.data.lot_number).toBe('101');
      expect(result.data.status).toBe('available');
    }
  });

  test('defaults status to available when omitted', () => {
    const input = {
      neighborhood_id: '123e4567-e89b-12d3-a456-426614174000',
      lot_number: '102'
    };
    
    const result = LotInsertSchema.safeParse(input);
    
    expect(result.success).toBe(true);
    if (result.success) {
      expect(result.data.status).toBe('available');
    }
  });
});
```

---

#### 1.2.5-UNIT-005: Lot Schema Invalid Status Enum (P0)

**Type:** Unit  
**Priority:** P0  
**File:** `packages/shared/lib/schemas/__tests__/lot.schema.test.ts`

**Test:**
```typescript
test('rejects invalid status value', () => {
  const invalidInput = {
    neighborhood_id: '123e4567-e89b-12d3-a456-426614174000',
    lot_number: '103',
    status: 'invalid-status'
  };
  
  const result = LotInsertSchema.safeParse(invalidInput);
  
  expect(result.success).toBe(false);
  if (!result.success) {
    expect(result.error.issues[0].path).toContain('status');
    expect(result.error.issues[0].message).toContain("'available'");
  }
});
```

---

#### 1.2.5-UNIT-006: Lot Schema Missing Required Fields (P0)

**Type:** Unit  
**Priority:** P0  
**File:** `packages/shared/lib/schemas/__tests__/lot.schema.test.ts`

**Test:**
```typescript
test('rejects missing neighborhood_id', () => {
  const invalidInput = {
    lot_number: '104'
  };
  
  const result = LotInsertSchema.safeParse(invalidInput);
  
  expect(result.success).toBe(false);
  if (!result.success) {
    expect(result.error.issues[0].path).toContain('neighborhood_id');
  }
});

test('rejects missing lot_number', () => {
  const invalidInput = {
    neighborhood_id: '123e4567-e89b-12d3-a456-426614174000'
  };
  
  const result = LotInsertSchema.safeParse(invalidInput);
  
  expect(result.success).toBe(false);
  if (!result.success) {
    expect(result.error.issues[0].path).toContain('lot_number');
  }
});
```

---

#### 1.2.5-UNIT-007: Lot Update Schema Partial Validation (P1)

**Type:** Unit  
**Priority:** P1  
**File:** `packages/shared/lib/schemas/__tests__/lot.schema.test.ts`

**Test:**
```typescript
describe('LotUpdateSchema', () => {
  test('allows partial updates', () => {
    const partialUpdate = {
      status: 'assigned' as const
    };
    
    const result = LotUpdateSchema.safeParse(partialUpdate);
    
    expect(result.success).toBe(true);
    if (result.success) {
      expect(result.data.status).toBe('assigned');
      expect(result.data.lot_number).toBeUndefined();
    }
  });

  test('rejects updates with id or neighborhood_id', () => {
    const invalidUpdate = {
      id: '123e4567-e89b-12d3-a456-426614174000',
      neighborhood_id: '123e4567-e89b-12d3-a456-426614174001',
      status: 'assigned' as const
    };
    
    const result = LotUpdateSchema.safeParse(invalidUpdate);
    
    // Schema should omit these fields
    expect(result.success).toBe(true);
    if (result.success) {
      expect(result.data.id).toBeUndefined();
      expect(result.data.neighborhood_id).toBeUndefined();
    }
  });
});
```

---

### AC3: Repository Functions

**Strategy:** Test validation logic separately from database queries

#### 1.2.5-UNIT-008: Neighborhood Validation - Tenant Exists Check (P0)

**Type:** Unit  
**Priority:** P0  
**File:** `packages/database/src/lib/repositories/__tests__/neighborhood.validation.test.ts`

**Test:**
```typescript
import { describe, test, expect } from 'vitest';
import { validateNeighborhoodInput } from '../neighborhood';

describe('validateNeighborhoodInput', () => {
  test('throws AppError for invalid tenant_id', () => {
    const input = {
      tenant_id: 'invalid',
      name: 'Test'
    };
    
    expect(() => validateNeighborhoodInput(input))
      .toThrow('Invalid tenant_id format');
  });

  test('accepts valid UUID tenant_id', () => {
    const input = {
      tenant_id: '123e4567-e89b-12d3-a456-426614174000',
      name: 'Valid Neighborhood'
    };
    
    expect(() => validateNeighborhoodInput(input)).not.toThrow();
  });

  test('throws for empty name', () => {
    const input = {
      tenant_id: '123e4567-e89b-12d3-a456-426614174000',
      name: ''
    };
    
    expect(() => validateNeighborhoodInput(input))
      .toThrow('Name cannot be empty');
  });
});
```

**Implementation Note:**
```typescript
// In neighborhood.ts repository
export function validateNeighborhoodInput(input: any): void {
  // Pure validation logic, no database calls
  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  
  if (!uuidRegex.test(input.tenant_id)) {
    throw new AppError('Invalid tenant_id format', 'VALIDATION_ERROR');
  }
  
  if (!input.name || input.name.trim().length === 0) {
    throw new AppError('Name cannot be empty', 'VALIDATION_ERROR');
  }
}
```

**Justification:** Pure function testing, no mocks needed

---

#### 1.2.5-UNIT-009: Lot Validation - Duplicate Check Logic (P0)

**Type:** Unit  
**Priority:** P0  
**File:** `packages/database/src/lib/repositories/__tests__/lot.validation.test.ts`

**Test:**
```typescript
import { describe, test, expect } from 'vitest';
import { checkDuplicateLotNumber } from '../lot';

describe('checkDuplicateLotNumber', () => {
  test('identifies duplicate in existing lots list', () => {
    const existingLots = [
      { id: '1', lot_number: '101', neighborhood_id: 'n1' },
      { id: '2', lot_number: '102', neighborhood_id: 'n1' }
    ];
    
    const isDuplicate = checkDuplicateLotNumber('101', existingLots);
    
    expect(isDuplicate).toBe(true);
  });

  test('allows same lot_number in different context', () => {
    const existingLots = [
      { id: '1', lot_number: '101', neighborhood_id: 'n1' }
    ];
    
    const isDuplicate = checkDuplicateLotNumber('102', existingLots);
    
    expect(isDuplicate).toBe(false);
  });

  test('handles empty lots list', () => {
    const existingLots: any[] = [];
    
    const isDuplicate = checkDuplicateLotNumber('101', existingLots);
    
    expect(isDuplicate).toBe(false);
  });
});
```

**Implementation:**
```typescript
// Pure utility function in lot.ts
export function checkDuplicateLotNumber(
  lotNumber: string, 
  existingLots: Array<{ lot_number: string }>
): boolean {
  return existingLots.some(lot => lot.lot_number === lotNumber);
}
```

---

#### 1.2.5-UNIT-010: Lot Validation - Status Transition Logic (P1)

**Type:** Unit  
**Priority:** P1  
**File:** `packages/database/src/lib/repositories/__tests__/lot.validation.test.ts`

**Test:**
```typescript
import { canTransitionStatus } from '../lot';

describe('canTransitionStatus', () => {
  test('allows available → assigned transition', () => {
    const canTransition = canTransitionStatus('available', 'assigned');
    expect(canTransition).toBe(true);
  });

  test('allows assigned → available transition', () => {
    const canTransition = canTransitionStatus('assigned', 'available');
    expect(canTransition).toBe(true);
  });

  test('prevents invalid transitions', () => {
    const canTransition = canTransitionStatus('invalid' as any, 'assigned');
    expect(canTransition).toBe(false);
  });
});
```

---

#### 1.2.5-UNIT-011: Lot Validation - Neighborhood Ownership (P0)

**Type:** Unit  
**Priority:** P0  
**File:** `packages/database/src/lib/repositories/__tests__/lot.validation.test.ts`

**Test:**
```typescript
import { validateLotNeighborhoodOwnership } from '../lot';

describe('validateLotNeighborhoodOwnership', () => {
  test('validates lot belongs to specified neighborhood', () => {
    const lot = {
      id: 'lot-1',
      neighborhood_id: 'neigh-1',
      lot_number: '101'
    };
    
    expect(() => 
      validateLotNeighborhoodOwnership(lot, 'neigh-1')
    ).not.toThrow();
  });

  test('throws when lot does not belong to neighborhood', () => {
    const lot = {
      id: 'lot-1',
      neighborhood_id: 'neigh-1',
      lot_number: '101'
    };
    
    expect(() => 
      validateLotNeighborhoodOwnership(lot, 'neigh-2')
    ).toThrow('Lot does not belong to specified neighborhood');
  });
});
```

---

#### 1.2.5-UNIT-012: Lot Validation - Geo Bounds Format (P2)

**Type:** Unit  
**Priority:** P2  
**File:** `packages/database/src/lib/repositories/__tests__/lot.validation.test.ts`

**Test:**
```typescript
import { validateGeoBounds } from '../lot';

describe('validateGeoBounds', () => {
  test('accepts valid GeoJSON polygon', () => {
    const validBounds = {
      type: 'Polygon',
      coordinates: [[[0, 0], [1, 0], [1, 1], [0, 1], [0, 0]]]
    };
    
    expect(() => validateGeoBounds(validBounds)).not.toThrow();
  });

  test('accepts null/undefined for optional bounds', () => {
    expect(() => validateGeoBounds(null)).not.toThrow();
    expect(() => validateGeoBounds(undefined)).not.toThrow();
  });

  test('throws for invalid GeoJSON structure', () => {
    const invalidBounds = {
      type: 'Invalid',
      coordinates: []
    };
    
    expect(() => validateGeoBounds(invalidBounds))
      .toThrow('Invalid geo_bounds format');
  });
});
```

---

### AC4: Server Actions

#### 1.2.5-UNIT-013: Admin Action - Authorization Check Logic (P0)

**Type:** Unit  
**Priority:** P0  
**File:** `apps/web/app/actions/__tests__/admin.validation.test.ts`

**Test:**
```typescript
import { describe, test, expect } from 'vitest';
import { canManageTenant, canManageNeighborhood } from '../admin';

describe('Admin Authorization Logic', () => {
  test('super_admin can manage any tenant', () => {
    const user = {
      id: 'user-1',
      tenant_id: 'tenant-a',
      role: 'super_admin'
    };
    
    const canManage = canManageTenant(user, 'tenant-b');
    
    expect(canManage).toBe(true);
  });

  test('tenant admin can only manage own tenant', () => {
    const user = {
      id: 'user-1',
      tenant_id: 'tenant-a',
      role: 'admin'
    };
    
    expect(canManageTenant(user, 'tenant-a')).toBe(true);
    expect(canManageTenant(user, 'tenant-b')).toBe(false);
  });

  test('regular user cannot manage any tenant', () => {
    const user = {
      id: 'user-1',
      tenant_id: 'tenant-a',
      role: 'resident'
    };
    
    expect(canManageTenant(user, 'tenant-a')).toBe(false);
  });
});
```

**Implementation:**
```typescript
// Pure authorization logic in admin.ts
export function canManageTenant(
  user: { role: string; tenant_id: string }, 
  targetTenantId: string
): boolean {
  if (user.role === 'super_admin') return true;
  if (user.role === 'admin' && user.tenant_id === targetTenantId) return true;
  return false;
}
```

---

#### 1.2.5-UNIT-014: Admin Action - Input Sanitization (P1)

**Type:** Unit  
**Priority:** P1  
**File:** `apps/web/app/actions/__tests__/admin.validation.test.ts`

**Test:**
```typescript
import { sanitizeNeighborhoodInput, sanitizeLotInput } from '../admin';

describe('Input Sanitization', () => {
  test('trims whitespace from neighborhood name', () => {
    const input = {
      tenant_id: '123e4567-e89b-12d3-a456-426614174000',
      name: '  Almendro  ',
      description: '  Test  '
    };
    
    const sanitized = sanitizeNeighborhoodInput(input);
    
    expect(sanitized.name).toBe('Almendro');
    expect(sanitized.description).toBe('Test');
  });

  test('normalizes lot_number format', () => {
    const input = {
      neighborhood_id: '123e4567-e89b-12d3-a456-426614174000',
      lot_number: ' lot-101 '
    };
    
    const sanitized = sanitizeLotInput(input);
    
    expect(sanitized.lot_number).toBe('LOT-101');
  });

  test('removes unsafe characters from input', () => {
    const input = {
      tenant_id: '123e4567-e89b-12d3-a456-426614174000',
      name: 'Test<script>alert(1)</script>',
      description: 'Safe text'
    };
    
    const sanitized = sanitizeNeighborhoodInput(input);
    
    expect(sanitized.name).not.toContain('<script>');
    expect(sanitized.name).toBe('Testscriptalert(1)/script');
  });
});
```

---

#### 1.2.5-UNIT-015: Admin Action - Error Response Format (P1)

**Type:** Unit  
**Priority:** P1  
**File:** `apps/web/app/actions/__tests__/admin.validation.test.ts`

**Test:**
```typescript
import { formatActionError } from '../admin';

describe('Action Error Formatting', () => {
  test('formats AppError to action result', () => {
    const appError = new AppError(
      'Invalid tenant_id',
      'VALIDATION_ERROR',
      { field: 'tenant_id' }
    );
    
    const result = formatActionError(appError);
    
    expect(result).toEqual({
      success: false,
      error: 'Invalid tenant_id',
      code: 'VALIDATION_ERROR'
    });
  });

  test('formats Zod error to action result', () => {
    const zodError = new ZodError([
      {
        code: 'invalid_type',
        path: ['name'],
        message: 'Required',
        expected: 'string',
        received: 'undefined'
      }
    ]);
    
    const result = formatActionError(zodError);
    
    expect(result.success).toBe(false);
    expect(result.error).toContain('Validation failed');
    expect(result.issues).toHaveLength(1);
  });

  test('formats unknown error safely', () => {
    const unknownError = new Error('Something went wrong');
    
    const result = formatActionError(unknownError);
    
    expect(result).toEqual({
      success: false,
      error: 'An unexpected error occurred'
    });
    // Should not leak internal error details
    expect(result.error).not.toContain('Something went wrong');
  });
});
```

**Implementation:**
```typescript
// In admin.ts
export function formatActionError(error: unknown): ActionResult<never> {
  if (error instanceof AppError) {
    return {
      success: false,
      error: error.message,
      code: error.code
    };
  }
  
  if (error instanceof ZodError) {
    return {
      success: false,
      error: 'Validation failed',
      issues: error.issues
    };
  }
  
  // Don't leak internal errors to client
  console.error('Unexpected error:', error);
  return {
    success: false,
    error: 'An unexpected error occurred'
  };
}
```

---

### Lightweight Integration Tests (Optional)

**Strategy:** These tests use actual Supabase client but with minimal setup. Run manually or in CI with real test database.

#### 1.2.5-INT-001: Create Neighborhood E2E (P1)

**Type:** Lightweight Integration  
**Priority:** P1  
**File:** `packages/database/src/lib/repositories/__tests__/neighborhood.queries.test.ts`

**Test:**
```typescript
import { describe, test, expect, beforeAll, afterAll } from 'vitest';
import { createClient } from '@supabase/supabase-js';
import { createNeighborhood, getNeighborhoodById } from '../neighborhood';

// Only run if TEST_SUPABASE_URL is set
const SKIP_INTEGRATION = !process.env.TEST_SUPABASE_URL;

describe.skipIf(SKIP_INTEGRATION)('Neighborhood Repository Integration', () => {
  let testTenantId: string;
  let supabase: any;

  beforeAll(async () => {
    supabase = createClient(
      process.env.TEST_SUPABASE_URL!,
      process.env.TEST_SUPABASE_ANON_KEY!
    );
    
    // Create test tenant
    const { data } = await supabase
      .from('tenants')
      .insert({ name: 'Test Tenant', slug: 'test-tenant' })
      .select()
      .single();
    
    testTenantId = data.id;
  });

  afterAll(async () => {
    // Cleanup
    await supabase
      .from('neighborhoods')
      .delete()
      .eq('tenant_id', testTenantId);
    
    await supabase
      .from('tenants')
      .delete()
      .eq('id', testTenantId);
  });

  test('creates and retrieves neighborhood', async () => {
    const input = {
      tenant_id: testTenantId,
      name: 'Integration Test Neighborhood',
      description: 'Created by integration test'
    };
    
    const created = await createNeighborhood(input);
    
    expect(created.id).toBeDefined();
    expect(created.name).toBe(input.name);
    
    const retrieved = await getNeighborhoodById(created.id);
    
    expect(retrieved).toBeDefined();
    expect(retrieved?.name).toBe(input.name);
  });
});
```

**Justification:** Real database test, but skippable if env vars not set. Developers can run locally with test database.

---

#### 1.2.5-INT-002: List Neighborhoods by Tenant (P1)

**Type:** Lightweight Integration  
**Priority:** P1  
**File:** `packages/database/src/lib/repositories/__tests__/neighborhood.queries.test.ts`

**Test:**
```typescript
test('lists neighborhoods scoped to tenant', async () => {
  // Create multiple neighborhoods
  const neigh1 = await createNeighborhood({
    tenant_id: testTenantId,
    name: 'Neighborhood 1'
  });
  
  const neigh2 = await createNeighborhood({
    tenant_id: testTenantId,
    name: 'Neighborhood 2'
  });
  
  const neighborhoods = await listNeighborhoodsByTenant(testTenantId);
  
  expect(neighborhoods.length).toBeGreaterThanOrEqual(2);
  expect(neighborhoods.some(n => n.id === neigh1.id)).toBe(true);
  expect(neighborhoods.some(n => n.id === neigh2.id)).toBe(true);
});
```

---

#### 1.2.5-INT-003: Create Lot with Duplicate Check (P0)

**Type:** Lightweight Integration  
**Priority:** P0  
**File:** `packages/database/src/lib/repositories/__tests__/lot.queries.test.ts`

**Test:**
```typescript
import { describe, test, expect, beforeAll, afterAll } from 'vitest';
import { createLot } from '../lot';
import { AppError } from '@shared/lib/errors';

const SKIP_INTEGRATION = !process.env.TEST_SUPABASE_URL;

describe.skipIf(SKIP_INTEGRATION)('Lot Repository Integration', () => {
  let testNeighborhoodId: string;

  beforeAll(async () => {
    // Setup test tenant and neighborhood
    // ... (similar to neighborhood test)
  });

  afterAll(async () => {
    // Cleanup
  });

  test('prevents duplicate lot_number in same neighborhood', async () => {
    const lot1 = await createLot({
      neighborhood_id: testNeighborhoodId,
      lot_number: '101'
    });
    
    expect(lot1.id).toBeDefined();
    
    // Attempt to create duplicate
    await expect(
      createLot({
        neighborhood_id: testNeighborhoodId,
        lot_number: '101'
      })
    ).rejects.toThrow('already exists');
  });

  test('allows same lot_number in different neighborhoods', async () => {
    // Create second neighborhood
    const neighborhood2 = await createNeighborhood({
      tenant_id: testTenantId,
      name: 'Neighborhood 2'
    });
    
    // Same lot number should work
    const lot2 = await createLot({
      neighborhood_id: neighborhood2.id,
      lot_number: '101'
    });
    
    expect(lot2.id).toBeDefined();
    expect(lot2.lot_number).toBe('101');
  });
});
```

---

#### 1.2.5-INT-004: Get Available Lots by Neighborhood (P1)

**Type:** Lightweight Integration  
**Priority:** P1  
**File:** `packages/database/src/lib/repositories/__tests__/lot.queries.test.ts`

**Test:**
```typescript
test('filters lots by status and neighborhood', async () => {
  // Create mix of available and assigned lots
  await createLot({
    neighborhood_id: testNeighborhoodId,
    lot_number: '201',
    status: 'available'
  });
  
  await createLot({
    neighborhood_id: testNeighborhoodId,
    lot_number: '202',
    status: 'assigned'
  });
  
  const availableLots = await getAvailableLotsByNeighborhood(testNeighborhoodId);
  
  expect(availableLots.every(lot => lot.status === 'available')).toBe(true);
  expect(availableLots.some(lot => lot.lot_number === '201')).toBe(true);
  expect(availableLots.some(lot => lot.lot_number === '202')).toBe(false);
});
```

---

#### 1.2.5-INT-005: Admin Action Complete Flow (P1)

**Type:** Lightweight Integration  
**Priority:** P1  
**File:** `apps/web/app/actions/__tests__/admin.integration.test.ts`

**Test:**
```typescript
import { describe, test, expect, beforeAll } from 'vitest';
import {
  createTenantAction,
  createNeighborhoodAction,
  createLotAction
} from '../admin';

const SKIP_INTEGRATION = !process.env.TEST_SUPABASE_URL;

describe.skipIf(SKIP_INTEGRATION)('Admin Actions Integration', () => {
  test('complete hierarchy creation flow', async () => {
    // 1. Create tenant
    const tenantResult = await createTenantAction({
      name: 'Integration Test Tenant',
      slug: 'integration-test'
    });
    
    expect(tenantResult.success).toBe(true);
    if (!tenantResult.success) return;
    
    const tenant = tenantResult.data;
    
    // 2. Create neighborhood
    const neighResult = await createNeighborhoodAction({
      tenant_id: tenant.id,
      name: 'Test Neighborhood'
    });
    
    expect(neighResult.success).toBe(true);
    if (!neighResult.success) return;
    
    const neighborhood = neighResult.data;
    
    // 3. Create lot
    const lotResult = await createLotAction({
      neighborhood_id: neighborhood.id,
      lot_number: '301'
    });
    
    expect(lotResult.success).toBe(true);
    if (!lotResult.success) return;
    
    const lot = lotResult.data;
    
    // Verify hierarchy
    expect(lot.neighborhood_id).toBe(neighborhood.id);
    expect(neighborhood.tenant_id).toBe(tenant.id);
  });
});
```

**Justification:** End-to-end action flow test with real database, validates entire stack

---

## Test Execution Strategy

### Phase 1: Pure Unit Tests (Day 1)

**Run Command:** `pnpm test --run`

**Files to Create:**
1. `neighborhood.schema.test.ts` (3 tests)
2. `lot.schema.test.ts` (4 tests)
3. `neighborhood.validation.test.ts` (3 tests)
4. `lot.validation.test.ts` (5 tests)
5. `admin.validation.test.ts` (3 tests)

**Total:** 18 pure unit tests, ~5 seconds execution

**Success Criteria:**
- ✅ All tests pass
- ✅ No TypeScript errors
- ✅ No mocks required
- ✅ Each file < 100 lines

---

### Phase 2: Lightweight Integration (Day 2, Optional)

**Run Command:** `TEST_SUPABASE_URL=... pnpm test:integration`

**Prerequisites:**
- Test Supabase instance available
- Environment variables set
- Can be skipped for local dev

**Files to Create:**
1. `neighborhood.queries.test.ts` (2 tests)
2. `lot.queries.test.ts` (2 tests)
3. `admin.integration.test.ts` (1 test)

**Total:** 5 integration tests, ~10 seconds execution

**Success Criteria:**
- ✅ Tests pass with real database
- ✅ Proper cleanup after each test
- ✅ Skip gracefully if env vars missing

---

### Phase 3: Manual RLS Verification (Before Production)

**Run Command:** Manual SQL execution

**Files to Create:**
1. `verify-neighborhood-isolation.sql`
2. `verify-lot-isolation.sql`

**Execution:** Copy SQL to Supabase SQL editor, run manually

**Success Criteria:**
- ✅ Cross-tenant queries return empty
- ✅ Own tenant queries return data
- ✅ No errors or leakage

---

## Test Configuration

### Vitest Config Updates

```typescript
// vitest.config.ts (packages/database)
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    include: ['**/*.test.ts'],
    exclude: [
      '**/node_modules/**',
      '**/dist/**',
      '**/*.integration.test.ts' // Separate integration tests
    ],
    coverage: {
      reporter: ['text', 'json', 'html'],
      exclude: [
        '**/__tests__/**',
        '**/test/**',
        '**/types/**'
      ]
    }
  }
});
```

### Separate Integration Config

```typescript
// vitest.integration.config.ts
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    include: ['**/*.integration.test.ts', '**/*.queries.test.ts'],
    testTimeout: 30000, // Longer timeout for real DB
    hookTimeout: 30000
  }
});
```

### Package.json Scripts

```json
{
  "scripts": {
    "test": "vitest --run",
    "test:watch": "vitest",
    "test:integration": "vitest --config vitest.integration.config.ts --run",
    "test:integration:watch": "vitest --config vitest.integration.config.ts",
    "test:unit": "vitest --run --exclude '**/*.integration.test.ts'",
    "test:coverage": "vitest --coverage"
  }
}
```

---

## Coverage Goals

### Unit Test Coverage

**Target:** 80% coverage for pure logic

**Files:**
- ✅ All Zod schemas (100%)
- ✅ Validation functions (100%)
- ✅ Authorization logic (100%)
- ✅ Input sanitization (90%)
- ✅ Error formatting (80%)

### Integration Test Coverage

**Target:** Critical paths only

**Scenarios:**
- ✅ Create hierarchy (tenant → neighborhood → lot)
- ✅ Duplicate prevention
- ✅ List operations
- ✅ Status transitions

### Manual RLS Coverage

**Target:** 100% of RLS policies

**Policies:**
- ✅ Neighborhood tenant isolation
- ✅ Lot neighborhood isolation
- ✅ Super admin bypass
- ✅ Tenant admin scope

---

## Risk Mitigation Through Testing

### SEC-001: RLS Misconfiguration
**Mitigated by:** Manual SQL verification tests (1.2.5-MANUAL-001, 002)

### DATA-001: Hierarchy Validation
**Mitigated by:** Unit tests 008-012 + Integration test 003

### TEST-001: Previous Test Failures
**Mitigated by:** 
- Pure unit tests (no complex mocks)
- Small focused files
- Optional integration tests
- Type-safe approach

### TECH-001: Error Handling
**Mitigated by:** Unit test 015 (error formatting)

### OPS-001: Seed Data
**Mitigated by:** Manual verification + integration setup/teardown

---

## Success Metrics

### Developer Experience
- ✅ Tests run in < 5 seconds (unit only)
- ✅ No mock configuration required for unit tests
- ✅ TypeScript errors = test is wrong, not test setup
- ✅ Each test file independently understandable

### Quality Gates
- ✅ All P0 unit tests pass (12 tests)
- ✅ All P1 unit tests pass (6 tests)
- ✅ Manual RLS verification completed
- ✅ Optional: Integration tests pass with test DB

### Code Quality
- ✅ Each test file < 100 lines
- ✅ No complex mocking frameworks
- ✅ Pure functions testable without setup
- ✅ Clear test names describe intent

---

## Troubleshooting Guide

### Issue: TypeScript Errors in Tests

**Solution:** Tests should never require type gymnastics
- If types don't match, extract testable pure functions
- Use actual types, not `any` or complex generics
- Test business logic, not type system

### Issue: Vitest Import Errors

**Solution:** Check module resolution
```typescript
// Use explicit extensions for local imports
import { func } from './module.js'; // Not './module'

// Or configure vitest.config.ts
export default defineConfig({
  resolve: {
    extensions: ['.ts', '.js']
  }
});
```

### Issue: Integration Tests Slow

**Solution:** Integration tests are optional
- Run unit tests by default: `pnpm test:unit`
- Run integration only in CI: `pnpm test:integration`
- Use `describe.skipIf(SKIP_INTEGRATION)` pattern

### Issue: Mock Setup Complex

**Solution:** Don't mock, refactor
- Extract pure validation logic (testable without mocks)
- Test business rules separately from I/O
- Use integration tests for full flow

---

## Next Steps After Tests Pass

1. **Document Test Patterns**
   - Add examples to project wiki
   - Create test template files
   - Update coding standards

2. **Extend to Story 1.2.6 (UI)**
   - Similar small test files
   - Test event handlers as pure functions
   - E2E tests separate from unit tests

3. **CI/CD Integration**
   - Unit tests: Run on every commit
   - Integration tests: Run on PR only
   - Manual RLS: Run before production deploy

4. **Monitoring**
   - Track test execution time
   - Alert if unit tests > 10 seconds
   - Coverage reports in PR comments

---

## Appendix: Test File Templates

### Pure Unit Test Template

```typescript
// packages/shared/lib/schemas/__tests__/example.schema.test.ts
import { describe, test, expect } from 'vitest';
import { ExampleSchema } from '../example';

describe('ExampleSchema', () => {
  test('validates correct input', () => {
    const valid = { field: 'value' };
    const result = ExampleSchema.safeParse(valid);
    expect(result.success).toBe(true);
  });

  test('rejects invalid input', () => {
    const invalid = { field: 123 };
    const result = ExampleSchema.safeParse(invalid);
    expect(result.success).toBe(false);
  });
});
```

### Lightweight Integration Template

```typescript
// packages/database/src/lib/repositories/__tests__/example.queries.test.ts
import { describe, test, expect, beforeAll, afterAll } from 'vitest';
import { exampleFunction } from '../example';

const SKIP_INTEGRATION = !process.env.TEST_SUPABASE_URL;

describe.skipIf(SKIP_INTEGRATION)('Example Integration', () => {
  beforeAll(async () => {
    // Setup test data
  });

  afterAll(async () => {
    // Cleanup
  });

  test('performs database operation', async () => {
    const result = await exampleFunction();
    expect(result).toBeDefined();
  });
});
```

---

**End of Test Design Document**